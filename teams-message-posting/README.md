# Teams 承認依頼投稿の @mention 自動化（Power Automate）

## 課題

ある特定のサーバにログインする際、事前に承認が必要な運用となっており、承認依頼を Microsoft Teams に投稿する必要があった。その際、以下のような投稿文を毎回手入力していた。

```
@Aさん @Bさん @Cさん  @Dさん
＜自分の名前＞です。＜申請番号＞の承認をお願いします。
```

この投稿は 1 日に複数回行うことがあり、複数名への @mention を毎回手で入力する作業が負担となっていた。

## この記事で分かること

- Teams 上で、複数名への @mention を含む承認依頼投稿を自動生成する方法（Power Automate使用）

## 前提条件

- 組織の Teams 環境であること（複数ユーザーへの @mention を行うため）
- Microsoft Teams が利用可能であること
- Power Automate が利用可能であること
- 本記事では、承認判断そのものの自動化は行わない

## 注意事項（再現方法について）

本フローは、Power Automate の GUI を用いて手動で構築している。

- 業務環境で構築したフローは持ち出せないため、JSON のエクスポートは行っていない。
- JSON にはテナント固有のパラメータが多く含まれ、マスキングコストが高いため、本記事では GUI による再作成を選択している。
- 掲載している画像は、あくまで構成理解のための参考である。

## 構成図

構成は非常に単純である。赤枠で示した部分は、メンション先の人数に応じて増やせばよい。

![image1.png](./images/image1.png)

## 手順

ブラウザで Power Automate を開き、［作成］から［インスタント クラウド フロー］を選択する。フロー名を入力し、トリガーとして［作成ボックスから（V2）］を選択する。

![image2.png](./images/image2.png)

フロー編集画面で「＋」を押し、アクションを追加する。

最初に追加するのは［マイ プロフィールの取得（V2）］である。このアクションには、特にパラメータを入力する必要はない。

次に、［ユーザーの @mention トークンを取得する］アクションを選択し、メンションしたいユーザーのメールアドレスを指定する。

![image3.png](./images/image3.png)

最後に、［チャットまたはチャネルでメッセージを投稿する］アクションを検索して選択し、必要なパラメータを入力する。

グループチャットについては、動作確認が完了するまでは仮のもの（誰かと作成したチャット）で問題ない。メッセージ欄には、いったんテスト用の文字列を入力して保存する。

## ポイント

ここで一度フローを保存できることが重要である。保存を行わないと、後続でメッセージに動的パラメータを埋め込むことができない。また、保存後にトリガー名が［作成ボックスから］から manual に自動的に変更されることに注意。

## メッセージ

メッセージ欄には、以下のように入力する。構文の詳細な意味については解説しないが、赤字部分はアクション名を指定している箇所であることが分かると思う。

また、[] 内には、各アクション実行後に取得するパラメータが記載されている。

```
@{outputs('ユーザーの_@mention_トークンを取得する')?['body/atMention']}さん、@{outputs('ユーザーの_@mention_トークンを取得する１')?['body/atMention']}さん

@{body('マイ_プロフィールの取得_(V2)')?['surname']}です。
番号:@{triggerBody()?['cardOutputs']?['number']}の承認お願いします。
```

最後の

`@{triggerBody()?['cardOutputs']?['number']}`

の値は、［作成ボックスから（V2）］（現在は名前が `manual` に変更されている）で入力した値を取得している。

この `number` というキーは、Adaptive Card の設定における **id 欄**と一致させる必要がある。

以下は、Adaptive Card Designer 上での設定例である。

[https://adaptivecards.io/designer/](https://adaptivecards.io/designer/)


![image4.png](./images/image4.png)

また送信ボタンは以下のように作成する

![image5.png](./images/image5.png)

どの項目がどの値と紐づいているか分かりにくい場合は、**メッセージを完成させる前に一度テストを実行して確認するのがよい**。

テスト結果は Power Automate の実行履歴から確認できる。例えば、現在は自分の名前を以下のように取得している。

```
@{body('マイ_プロフィールの取得_(V2)')?['surname']}です。
```

これは、［マイ プロフィールの取得（V2）］アクションの実行結果に含まれる `body` ブロックのうち、`surname` フィールドの値を抜き出しているだけである。

そのため、フルネームを表示したい場合は、同じ `body` 内の `displayName` フィールドを指定すればよい。
